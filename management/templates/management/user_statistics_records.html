{% extends "health_base.html" %}
{% load staticfiles %}

{% block content %}
<script>
    $(function(){
        $('.apply').click(function () {
            var record_id = $(this).attr('record_id');
            var status = 'not_sure';
            $.messager.confirm('修改申请确认', '确定要申请修改服务结果吗？', function(flag){
                if (flag) {
                    $.ajax({
                        url: '/management/rectify_apply/',
                        data: {
                            id: record_id
                        },
                        success: function(response, status, xhr) {
                            if (status == 'success'){
                            }
                        }
                    });
                }
            });
            $(this).parent().html('等待审核');
        })
    })
</script>
<div class="container">
    <div class="col-xs-7 col-sm-10 col-md-10 main">
    {% block admin_work %}
        <div class="row">
            <hr/>
            <form class="form-horizontal" role="form" method="POST" action="{% url 'management:user_statistics_records' %}">
                {% csrf_token %}
                <!-- data range select -->
                {% include 'management/date_range.html' %}
                <!-- service type and item select -->
                {% include 'management/user_statistics_service_type_item_select.html' %}

                <div class="row" style="padding-top: 10px">
                    <div class="col-md-12" align="right">
                        <button type="submit" class="btn btn-default">查询</button>
                    </div>
                </div>
            </form>
        </div>
                <div class="row">
                    <h5 class="page-header" align="left">查询到服务记录{{ records | length }}个：</h5>
                    {% if err_msg %}
                    <h5 class="page-header" align="left">{{ err_msg }}</h5>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>居民姓名</th>
                                    <th>服务类别</th>
                                    <th>服务项目</th>
                                    <th>完成时间</th>
                                    <th>当前状态</th>
                                    <th>修改结果</th>
                                    <th>详情</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for record in records %}
                                <tr>
                                    <th>{% if record.resident.name == "没有人" %}{% else %}{{ record.resident.name }}{% endif %}</th>
                                    <th>{{ record.service_item.service_type.name }}</th>
                                    <th>{{ record.service_item.name }}</th>
                                    <th>{{ record.submit_time | date:"Y-m-d H:i" }}</th>
                                    <th>{% if record.status == 1 %}  开始
                                        {% elif record.status == 2 %}暂存
                                        {% elif record.status == 3 %}完成
                                        {% elif record.status == 4 %}支付完毕
                                        {% else %}                   未知
                                        {% endif %}
                                    </th>
                                    <th>
                                        {% if record.rectificationapply %}
                                            {% if record.rectificationapply.apply_status == 3 %}
                                                修改
                                            {% elif record.rectificationapply.apply_status == 4 %}
                                                被拒
                                            {% endif %}
                                        {% else %}
                                            <a class="apply" record_id={{ record.id }}>申请</a>
                                        {% endif %}
                                    </th>
                                    <th><a href="/management/service_details/user_statistics_records/{{ record.id }}/">详情</a></th>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
        <div class="row">
            <hr style="color: green"/>
            <div class="col-md-4 col-md-offset-4" align="center">
                <a href="{% url 'management:userprofile_index' %}" class="btn btn-default">返回</a>
            </div>
        </div>
    {% endblock %}
        </div>
    </div>
</div>
{% endblock %}