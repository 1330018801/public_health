{% extends "management/admin_base.html" %}
{% load staticfiles %}

{% block admin_work %}
    <!--
        {% if user.userprofile.role.name == "卫生院管理员" %}
            <a href="{% url 'management:town_staff_resident_add' %}">
        {% else %}
            <a href="{% url 'management:resident_add' %}">
        {% endif %}

        <h5 class="page-header" align="left">添加常住居民</h5></a>
    -->

    <div style="height: 60px">
        <button id="resident_add_btn" class="btn btn-info">添加常住居民</button>
    </div>

    <div id="resident_query">
        <form id="resident_query_form" class="form-inline" role="form" method="POST" action="
            {% if user.userprofile.role.name == "卫生院管理员" %}
               {% url 'management:town_staff_resident_list' %}
            {% else %}
               {% url 'management:resident_list' %}
            {% endif %}">

            {% csrf_token %}

            <table style="width: 900px; font-size: 13px; line-height: 30px">
            <tr>
            {% if user.userprofile.role.name != "卫生院管理员" %}
                <td width="10%">所在乡镇:</td>
                <td width="20%">
                    <select id="town" name="town">
                        <option value="0">请选择</option>
                        {% for the_town in towns %}
                            <option value="{{ the_town.id }}">{{ the_town.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td width="10%">所在村庄:</td>
                <td width="20%">
                    <select id="village" name="village">
                        <option value="0">请选择</option>
                    </select>
                </td>
                <td width="40%" colspan="3"></td>
            {% else %}
                <td width="10%">所在村庄:</td>
                <td width="20%">
                    <select id="village" name="village">
                        <option value="0">请选择</option>
                        {% for the_village in villages %}
                            {% if the_village == village %}
                            <option value="{{ the_village.id }}" selected>{{ the_village.name }}</option>
                            {% else %}
                            <option value="{{ the_village.id }}">{{ the_village.name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </td>
                <td width="70%" colspan="5"></td>
            {% endif %}
            </tr>
            <tr>
                <td width="10%">姓名:</td>
                <td width="20%" style="line-height: 15px">
                    {% if name %}
                    <input type="text" name="name" size="8" value="{{ name }}"/>
                    {% else %}
                    <input type="text" name="name" size="8"/>
                    {% endif %}
                </td>
                <td width="10%">性别:</td>
                <td width="20%">
                    <select name="gender">
                        {% if gender != None %}
                            {% if gender == 1 %}
                            <option value="2" >全部</option>
                            <option value="1" selected>男</option>
                            <option value="0">女</option>
                            {% elif gender == 0 %}
                            <option value="2" >全部</option>
                            <option value="1">男</option>
                            <option value="0" selected>女</option>
                            {% else %}
                            <option value="2" selected>全部</option>
                            <option value="1">男</option>
                            <option value="0" >女</option>
                            {% endif %}
                        {% else %}
                            <option value="2" selected>全部</option>
                            <option value="1">男</option>
                            <option value="0" >女</option>
                        {% endif %}
                    </select>
                </td>
                <td width="10%">身份证号码:</td>
                <td width="20%" style="line-height: 15px">
                    {% if identity %}
                    <input type="text" name="identity" value="{{ identity }}"/>
                    {% else %}
                    <input type="text" name="identity"/>
                    {% endif %}
                </td>
                <td width="10%"> </td>
            </tr>
            <tr>
                <td style="line-height: 20px" colspan="7">
                    <button type="submit">筛选</button>
                </td>
            </tr>
            </table>
        </form>
    </div>
    
    <hr/>

        <h5 class="page-header" align="left">常住居民共有{{ residents.count }}位:</h5>

            {% if err_msg %}
                <h5 class="page-header" align="left">{{ err_msg }}</h5>
            {% endif %}

        <div class="table-responsive" style="width: 900px">
            <table class="table table-striped" style="font-size: 13px; line-height: 30px">
                <thead>
                <tr>
                    <th>姓名</th><th>身份证号码</th><th>性别</th><th>民族</th><th>出生日期</th>
                    <th>地区</th><th>住址</th><th>手机</th><th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for resident in residents %}
                <tr>
                    <td>{{ resident.name }}</td>
                    <td>{% if resident.identity != None %}
                            {{ resident.identity }}
                        {% endif %}
                    </td>
                    <td>{% if resident.gender == 1 %}男{% elif resident.gender == 0 %}女{% else %}未知{% endif %}</td>
                    <td>{{ resident.nation}}</td>
                    <td>{% if resident.birthday %}{{ resident.birthday| date:"Y年m月d日" }}{% endif %}</td>
                    <td>
                        {% if resident.town %}{{ resident.town.name }}{% endif %}
                        {% if resident.village %}{{ resident.village.name }}{% endif %}
                    </td>
                    <td>{% if resident.address != None %}
                            {{ resident.address }}
                        {% endif %}
                    </td>
                    <td>{% if resident.mobile != None %}
                            {{ resident.mobile }}
                        {% endif %}
                    </td>
                    <td>{% if user.userprofile.role.name == "卫生院管理员" %}
                            <a type="button" href="/management/town_staff_resident/edit/{{ resident.id }}/">修改</a>|
                        {% else %}
                            <button class="resident_edit" resident_id={{ resident.id }}/>修改</button>
                        {% endif %}
                            <button class="resident_del" resident_id={{ resident.id }}>删除</button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    <script>
        $(document).ready(function() {
            $("select#town").change(function() {
                if ($(this).val() == '0'){
                    $("select#village").html("<option>请选择</option>");
                    $("select#village").attr('disabled', true);
                }
                else {
                    var url = "/management/town/" + $(this).val() + "/villages/";
                    $.getJSON(url, function(villages) {
                        var options = '<option value="0">请选择</option>';
                        for (var i = 0; i < villages.length; i++) {
                            options += '<option value="' + villages[i].pk + '">' + villages[i].fields['name'] + '</option>';
                        }
                        $("select#village").html(options);
                        $("select#village option:first").attr('selected', 'selected');
                        $("select#village").attr('disabled', false);
                    });
                }
            });
        })
    </script>

    <div id="resident_add">
        <form id="resident_add_form" method="post">
            {% csrf_token %}
            <table>
                <tr>
                    <td width="20%" align="right" >
                        <label for="name">姓名：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-textbox easyui_validatebox" data-options="required: true" name="name" id="name" />
                    </td>
                    <td width="20%" align="right">
                        <label for="gender">性别：</label>
                    </td>
                    <td width="30%">
                        <input type="radio" name="gender" id="gender_male" value="1" style="margin-left: 10px" checked="checked">男</input>
                        <input type="radio" name="gender" id="gender_female" value="0" style="margin-left: 10px">女</input>
                    </td>
                </tr>
                <tr>
                    <td width="20%" align="right" >
                        <label for="identity">身份证号码：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-textbox easyui_validatebox" data-options="required: true" name="identity" id="identity" />
                    </td>
                    <td width="20%" align="right">
                        <label for="nation">民族：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-textbox" name="nation" id="nation" />
                    </td>
                </tr>
                <tr>
                    <td width="20%" align="right" >
                        <label for="town1">乡镇：</label>
                    </td>
                    <td width="30%">
                        <input name="town1" id="town1" />
                    </td>
                    <td width="20%" align="right">
                        <label for="village1">村/街道/社区：</label>
                    </td>
                    <td width="30%">
                        <input name="village1" id="village1" />
                    </td>
                </tr>
                <tr>
                    <td width="20%" align="right">
                        <label for="address">地址：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-textbox" name="address" id="address"/>
                    </td>
                    <td width="20%" align="right">
                        <label for="birthday">出生日期：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-datebox" name="birthday" id="birthday"/>
                    </td>
                </tr>
                <tr>
                    <td width="20%" align="right" >
                        <label for="mobile">电话号码：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-textbox easyui_validatebox" data-options="required: true" name="mobile" id="mobile" />
                    </td>
                    <td width="20%" align="right">
                        <label for="email">电子邮箱：</label>
                    </td>
                    <td width="30%">
                        <input class="easyui-textbox" name="email" id="email" />
                    </td>
                </tr>
            </table>
        </form>
    </div>

    <div id="resident_edit"></div>

{% endblock %}

{% block page_js %}
    <script src='{% static "js/resident_list.js" %}'></script>
{% endblock %}